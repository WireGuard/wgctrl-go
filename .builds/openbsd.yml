image: openbsd/latest
packages:
  - bash
  - go
sources:
  - https://github.com/WireGuard/wgctrl-go
environment:
  GO111MODULE: "on"
  GOBIN: "/home/build/go/bin"
tasks:
  - setup-wireguard: |
      ./wgctrl-go/.cibuild.sh
  - build: |
      go version
      go install honnef.co/go/tools/cmd/staticcheck@latest
      cd wgctrl-go/
      diff -u <(echo -n) <(/usr/local/go/bin/gofmt -d -s .)
      go vet ./...
      $GOBIN/staticcheck ./...
      # The race detector is not supported on OpenBSD.
      go test -v ./...
      # 32-bit sanity checking for different kernel structure sizes.
      GOARCH=386 go build ./...
      go test -c .
      # TODO: re-enable once Go 1.18 is available in openbsd/latest and wireguard-go can be built
      exit 0
      # Use wireguard-go for additional testing.
      doas /home/build/go/bin/wireguard-go tun0
      doas bash -c 'WGCTRL_INTEGRATION=yesreallydoit ./wgctrl.test -test.v -test.run TestIntegration'
